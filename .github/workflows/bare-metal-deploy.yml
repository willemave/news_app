name: Bare Metal Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Push app to bare metal
    runs-on: ubuntu-latest
    concurrency: news-app-bare-metal-deploy
    environment: production
    env:
      DEPLOY_REMOTE_DIR: ${{ vars.DEPLOY_REMOTE_DIR }}
      DEPLOY_OWNER_GROUP: ${{ vars.DEPLOY_OWNER_GROUP }}
      DEPLOY_PROGRAMS: ${{ vars.DEPLOY_PROGRAMS }}
      DEPLOY_PYTHON_VERSION: ${{ vars.DEPLOY_PYTHON_VERSION }}
      DEPLOY_SSH_PORT: ${{ vars.DEPLOY_SSH_PORT }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Start ssh-agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

      - name: Trust remote host key
        env:
          DEPLOY_SSH_HOST: ${{ secrets.DEPLOY_SSH_HOST }}
          DEPLOY_SSH_PORT: ${{ vars.DEPLOY_SSH_PORT }}
        run: |
          set -euo pipefail
          if [[ -z "${DEPLOY_SSH_HOST:-}" ]]; then
            echo "DEPLOY_SSH_HOST secret is not set" >&2
            exit 1
          fi
          PORT="${DEPLOY_SSH_PORT:-22}"
          mkdir -p ~/.ssh
          ssh-keyscan -p "$PORT" -H "$DEPLOY_SSH_HOST" >> ~/.ssh/known_hosts

      - name: Rsync build to server and restart services
        env:
          DEPLOY_SSH_USER: ${{ secrets.DEPLOY_SSH_USER }}
          DEPLOY_SSH_HOST: ${{ secrets.DEPLOY_SSH_HOST }}
          DEPLOY_SSH_PORT: ${{ vars.DEPLOY_SSH_PORT }}
        run: |
          set -euo pipefail

          if [[ -z "${DEPLOY_SSH_USER:-}" || -z "${DEPLOY_SSH_HOST:-}" ]]; then
            echo "DEPLOY_SSH_USER and DEPLOY_SSH_HOST secrets are required" >&2
            exit 1
          fi

          REMOTE="${DEPLOY_SSH_USER}@${DEPLOY_SSH_HOST}"
          PORT="${DEPLOY_SSH_PORT:-22}"
          SSH_OPTS=(-p "$PORT" -o StrictHostKeyChecking=yes -o BatchMode=yes)
          REMOTE_DIR="${DEPLOY_REMOTE_DIR:-/opt/news_app}"
          OWNER_GROUP="${DEPLOY_OWNER_GROUP:-newsapp:newsapp}"
          PROGRAMS="${DEPLOY_PROGRAMS:-news_app_server news_app_workers news_app_workers_content news_app_workers_onboarding news_app_workers_chat news_app_scrapers}"

          echo "→ Verifying SSH connectivity"
          ssh "${SSH_OPTS[@]}" "$REMOTE" "echo 'SSH ok: $(whoami)@$(hostname) on port $PORT'"

          echo "→ Ensuring remote path and ownership"
          ssh "${SSH_OPTS[@]}" "$REMOTE" "sudo mkdir -p '$REMOTE_DIR' && sudo chown '$OWNER_GROUP' '$REMOTE_DIR' && sudo chmod 755 '$REMOTE_DIR'"

          echo "→ Syncing repo (excluding .venv) to $REMOTE:$REMOTE_DIR"
          EXCLUDES=(
            ".git/"
            ".github/"
            ".worktrees/"
            ".venv/"
            "ai-memory/"
            "archive/"
            "client/"
            "data/"
            "env/"
            "logs/"
            "node_modules/"
            "__pycache__/"
            ".ruff_cache/"
            ".pytest_cache/"
            ".benchmarks/"
            "*.pyc"
            "*.pyo"
            "*.db"
            "*.sqlite"
            ".DS_Store"
            ".env"
            ".env.*"
          )

          RSYNC_ARGS=(-az --delete --rsync-path="sudo rsync" --info=progress2 --chown="$OWNER_GROUP" -e "ssh -p $PORT -o StrictHostKeyChecking=yes -o BatchMode=yes")
          for ex in "${EXCLUDES[@]}"; do
            RSYNC_ARGS+=(--exclude "$ex")
          done

          rsync "${RSYNC_ARGS[@]}" ./ "$REMOTE:$REMOTE_DIR/"

          echo "→ Refreshing env file if present"
          ssh "${SSH_OPTS[@]}" "$REMOTE" "cd '$REMOTE_DIR' && if [[ -f .env.racknerd ]]; then sudo cp .env.racknerd .env && sudo chown '$OWNER_GROUP' .env && sudo chmod 600 .env; else echo 'Warning: .env.racknerd missing; skipping copy' >&2; fi"

          SERVICE_USER="${OWNER_GROUP%%:*}"
          PY_VERSION="${DEPLOY_PYTHON_VERSION:-3.13}"
          echo "→ Resolving supervisor programs to stop/start"
          RESOLVED_PROGRAMS=$(ssh "${SSH_OPTS[@]}" "$REMOTE" "bash -lc '
            set -euo pipefail
            existing=\$(sudo supervisorctl status | sed -E \"s/[[:space:]].*$//\")
            resolved=\"\"
            for p in $PROGRAMS; do
              if echo \"\$existing\" | grep -qx \"\$p\"; then
                resolved+=\"\$p \"
              fi
            done
            echo \"\${resolved}\" | xargs
          '")
          if [[ -z "${RESOLVED_PROGRAMS:-}" ]]; then
            echo "No matching supervisor programs found for: $PROGRAMS" >&2
            exit 1
          fi
          echo "→ Supervisor programs: $RESOLVED_PROGRAMS"

          echo "→ Stopping supervisor programs"
          ssh "${SSH_OPTS[@]}" "$REMOTE" "sudo supervisorctl stop $RESOLVED_PROGRAMS || true"

          echo "→ Setting up Python environment on remote (uv venv, deps, playwright)"
          ssh "${SSH_OPTS[@]}" "$REMOTE" "sudo -u $SERVICE_USER -H bash -lc 'cd $REMOTE_DIR && ./scripts/setup_uv_env.sh --python-version $PY_VERSION --recreate'"

          echo "→ Running Alembic migrations"
          ssh "${SSH_OPTS[@]}" "$REMOTE" "sudo -u $SERVICE_USER -H bash -lc 'cd $REMOTE_DIR && ./scripts/check_and_run_migrations.sh'"

          echo "→ Syncing cron from repo crontab"
          ssh "${SSH_OPTS[@]}" "$REMOTE" "bash -lc '
            set -euo pipefail
            CRON_FILE=\"$REMOTE_DIR/crontab\"
            if [[ ! -f \"\$CRON_FILE\" ]]; then
              echo \"Missing \$CRON_FILE\" >&2
              exit 1
            fi
            sudo -u $SERVICE_USER -H bash -lc \"crontab \\\"\$CRON_FILE\\\" && crontab -l\"
          '"

          echo "→ Restarting supervisor programs"
          ssh "${SSH_OPTS[@]}" "$REMOTE" "sudo supervisorctl reread && sudo supervisorctl update && sudo supervisorctl start $RESOLVED_PROGRAMS && sudo supervisorctl status"
