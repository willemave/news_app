
#### 1  Python / FastAPI Coding Rules
* **Functions over classes**.
* **Full type hints**; validate with **Pydantic v2** models. Use `typing` for complex types.
* **RORO** pattern (receive object, return object).
* `lower_snake_case` for files/dirs; verbs in variables (`is_valid`, `has_permission`).
* Guard-clause error handling; early returns over nested `else`.
* **Docstrings**: Use Google-style for all public functions/classes.
* **Constants**: Define in `app/constants.py` or module-level UPPER_CASE.
---
#### 2  FastAPI Best Practices
* Use **lifespan** context, not `startup/shutdown` events.
* Inject DB/session with dependencies; use `Annotated` for cleaner signatures.
* Middleware order matters: logging → tracing → CORS → error capture.

---
#### 3  Code Quality & Safety
* **No hardcoded secrets**; use `pydantic-settings` for config management.
* **Input validation**: Always validate at boundaries (API, external services).
* **SQL injection prevention**: Use parameterized queries, never f-strings.
* **Graceful degradation**: Circuit breakers for external services.
* **Error context**: Include request IDs, user context in error logs.

---
#### 4  Testing Requirements
* **Write tests for all new functionality** in `app/tests/` using idiomatic pytest.
* Test structure mirrors app structure: `tests/routers/`, `tests/services/`, etc.
* Test file naming: `test_<module_name>.py`.
* **Test categories**:
  - Unit tests: isolated function/class testing
  - Integration tests: API endpoints with test DB
  - Contract tests: external service interactions
* Use pytest fixtures for setup/teardown;
* **TestClient** from FastAPI for endpoint testing.
* Mock external dependencies with `pytest-mock` or `unittest.mock`.
* **Run tests after implementation**: 
  pytest app/tests/ -v  # verbose output

* **Test data**: Use factories or fixtures, never production data.

---
#### 6  Dependencies (Complete)

**Requires Python ≥3.13**. All dependencies managed via `uv` (defined in `pyproject.toml`).

**Core Web Framework:**
- `fastapi>=0.115.12` - Web framework
- `uvicorn>=0.34.2` - ASGI server
- `pydantic>=2.11.5` - Data validation
- `pydantic-settings>=2.9.1` - Configuration management
- `python-multipart` - Form data handling
- `jinja2>=3.1.6` - HTML templates
- `markupsafe>=3.0.2` - HTML escaping

**Database:**
- `sqlalchemy>=2.0.41` - ORM
- `alembic>=1.16.1` - Database migrations

**Authentication:**
- `pyjwt[crypto]` - JWT token generation/validation
- `passlib[bcrypt]` - Password hashing
- `authlib>=1.6.5` - OAuth/Apple Sign In
- `email-validator>=2.3.0` - Email validation

**LLM Services:**
- `openai>=1.75.0` - OpenAI GPT
- `anthropic>=0.72.0` - Anthropic Claude
- `google-genai>=1.18.0` - Google Gemini (**NOT** google-generativeai)
- `tenacity>=9.1.2` - Retry logic with exponential backoff

**Content Processing:**
- `crawl4ai>=0.7.4,<0.8` - HTML/web content extraction
- `playwright>=1.53.0` - Browser automation
- `feedparser>=6.0.11` - RSS/Atom feed parsing
- `yt-dlp @ git+https://github.com/yt-dlp/yt-dlp.git` - YouTube downloader
- `bgutil-ytdlp-pot-provider>=1.2.2` - yt-dlp provider plugin
- `openai-whisper>=20250625` - Audio transcription (local)
- `ffmpeg-python>=0.2.0` - Audio processing
- `torch>=2.8.0` - ML backend for Whisper
- `markdown>=3.8` - Markdown processing

**Reddit Integration:**
- `praw>=7.7.1` - Reddit API client (Python Reddit API Wrapper)

**HTTP & Utilities:**
- `requests>=2.32.3` - HTTP client
- `python-dateutil>=2.9.0.post0` - Date/time parsing
- `pyyaml>=6.0.2` - YAML configuration
- `jmespath>=1.0.1` - JSON querying
- `nest-asyncio>=1.6.0` - Nested event loop support
- `rich>=14.2.0` - Terminal formatting/logging

**Development & Testing:**
- `pytest>=8.3.5` - Testing framework
- `pytest-asyncio>=1.0.0` - Async test support
- `pytest-cov>=6.1.1` - Coverage reporting
- `pytest-mock>=3.14.1` - Mocking utilities
- `ruff>=0.11.12` - Fast Python linter/formatter

**Package Management:**
```bash
# Install all dependencies
uv sync

# Add new dependency
uv add <package-name>

# Add dev dependency
uv add --dev <package-name>

# Activate virtual environment
source .venv/bin/activate

# Examples
uv add requests
uv add --dev pytest-benchmark
```

---
#### 7  Development Workflow
* **Pre-commit hooks**: `ruff` for linting, `black` for formatting
* **Environment management**: `.env.example` template; never commit `.env`. Use app/core/settings.py and Pydantic to store settings for the app. 
* **Database migrations**: Alembic with descriptive revision messages.
* **UI**: We use jinja and basic templates to render our html pages, we're not a javascript/react app. 
* **Error responses**: Consistent format with error codes, messages, details.
* We use tailwindcss, you write tailwind css to ./static/css/styles.css and then run `npx @tailwindcss/cli -i ./static/css/styles.css -o ./static/css/app.css` to build the ./static/css/styles.css
---

#### Tools
1. Use `uv add` to add python packages
2. Use `alembic` for database migrations
3. Use `ruff check` and `ruff format` for code quality
4. Use `mypy` for type checking
5. Make sure to ALWAYS run activate before the command. 

#### Better dev env tools, please use these. 

* Tool: **fd**
  What: Fast, user-friendly file finder
  Typical: `fd src`, `fd -e ts foo`
  Why: Simpler syntax and faster than `find`; ignores `.gitignore` by default.

* Tool: **ripgrep (rg)**
  What: Code searcher (recursive grep)
  Typical: `rg "TODO"`, `rg -n --glob '!dist'`
  Why: Much faster than grep/ack/ag; respects `.gitignore`.

* Tool: **ast-grep (sg)**
  What: AST-aware code search & refactor
  Typical: `sg -p 'if ($A) { $B }'`
  Why: Searches syntax, not text; enables precise, code-wide refactors.

* Tool: **jq**
  What: JSON processor
  Typical: `cat resp.json | jq '.items[].id'`
  Why: Reliable JSON querying and transforms from the shell.

* Tool: **fzf**
  What: Fuzzy finder (anything → filtered list)
  Typical: `fzf`, `history | fzf`
  Why: Interactive selection; composes with any command output.

* Tool: **bat**
  What: `cat` with wings: syntax, paging, git
  Typical: `bat file.ts`, `bat -p README.md`
  Why: Syntax highlighting, line numbers, Git integration.

* Tool: **eza**
  What: Modern `ls`
  Typical: `eza -l --git`, `eza -T`
  Why: Better defaults, trees/icons/git info; more readable.

* Tool: **httpie**
  What: Human-friendly HTTP client
  Typical: `http GET api/foo`, `http POST api bar=1`
  Why: Cleaner than `curl` for JSON; pretty output, headers, colors.

* Tool: **git-delta (delta)**
  What: Better `git diff`/pager
  Typical: `git -c core.pager=delta diff`
  Why: Side-by-side, syntax-colored diffs; easier reviews.


**Keep all replies short, technical, and complete.**
```
---
#### 11  Complete Project Structure (Nov 2025)
Use this as the authoritative layout.

**Python Backend (`app/`):**
```
app/
├── core/                          # Core infrastructure
│   ├── db.py                     # SQLAlchemy engine, sessions, init_db()
│   ├── settings.py               # Pydantic v2 settings from .env
│   ├── logging.py                # Root logger setup
│   ├── security.py               # JWT utils, Apple token validation
│   └── deps.py                   # FastAPI auth dependencies
│
├── models/                        # Database & domain models
│   ├── schema.py                 # SQLAlchemy models (Content, ProcessingTask, etc.)
│   ├── user.py                   # User model + auth Pydantic schemas
│   ├── metadata.py               # Unified Pydantic metadata models
│   ├── pagination.py             # Pagination models
│   └── scraper_runs.py           # ScraperStats dataclass
│
├── routers/                       # FastAPI endpoints
│   ├── auth.py                   # Apple Sign In, refresh, admin login/logout
│   ├── content.py                # Web UI routes (/, /content/{id}, /favorites)
│   ├── admin.py                  # Admin dashboard (/admin/)
│   ├── logs.py                   # Log viewing & error analysis
│   ├── api_content.py            # API backward compatibility layer
│   └── api/                      # Refactored API routes
│       ├── __init__.py           # Combined router
│       ├── models.py             # API Pydantic schemas
│       ├── content_list.py       # GET /, /search, /unread-counts
│       ├── content_detail.py     # GET /{id}, /chatgpt-url
│       ├── read_status.py        # POST /mark-read, /bulk-mark-read
│       ├── favorites.py          # POST /favorites/toggle, GET /favorites
│       └── content_actions.py    # POST /convert (news→article)
│
├── services/                      # Business logic
│   ├── anthropic_llm.py          # Anthropic Claude integration
│   ├── openai_llm.py             # OpenAI GPT integration (summarization)
│   ├── google_flash.py           # Google Gemini Flash integration
│   ├── llm_prompts.py            # LLM prompt templates
│   ├── event_logger.py           # EventLog service
│   ├── favorites.py              # User favorites operations
│   ├── read_status.py            # User read status tracking
│   ├── queue.py                  # Queue service & stats
│   ├── http.py                   # HTTP client helpers
│   └── whisper_local.py          # Local Whisper transcription
│
├── pipeline/                      # Task processing
│   ├── sequential_task_processor.py  # Main orchestrator
│   ├── worker.py                 # ContentWorker (articles/news)
│   ├── podcast_workers.py        # PodcastDownloadWorker, TranscribeWorker
│   └── checkout.py               # Content checkout mechanism
│
├── scraping/                      # Content scrapers
│   ├── runner.py                 # Scraper orchestrator
│   ├── base.py                   # Base scraper class
│   ├── substack_unified.py       # Substack scraper
│   ├── podcast_unified.py        # Podcast RSS/download
│   ├── hackernews_unified.py     # Hacker News
│   ├── reddit_unified.py         # Reddit (via PRAW)
│   ├── twitter_unified.py        # Twitter/X
│   ├── techmeme_unified.py       # Techmeme aggregator
│   ├── youtube_unified.py        # YouTube videos
│   └── atom_unified.py           # Generic Atom/RSS feeds
│
├── processing_strategies/         # Content-type processors
│   ├── base_strategy.py          # Base strategy interface
│   ├── registry.py               # Strategy registry
│   ├── html_strategy.py          # HTML extraction (crawl4ai)
│   ├── pdf_strategy.py           # PDF extraction
│   ├── arxiv_strategy.py         # arXiv papers
│   ├── pubmed_strategy.py        # PubMed articles
│   ├── hackernews_strategy.py    # HN comment extraction
│   ├── youtube_strategy.py       # YouTube transcript/metadata
│   └── image_strategy.py         # Image content
│
├── http_client/
│   └── robust_http_client.py     # Resilient HTTP with retries
│
├── utils/
│   ├── error_logger.py           # JSONL error logging
│   ├── pagination.py             # Cursor pagination utils
│   ├── paths.py                  # Path utilities
│   └── json_repair.py            # JSON repair utilities
│
├── domain/
│   └── converters.py             # ORM→Pydantic converters
│
├── templates.py                   # Jinja2 template config
├── constants.py                   # App-wide constants
└── main.py                        # FastAPI app entry point
```

**iOS Client (`client/newsly/newsly/`):**
```
client/newsly/newsly/
├── newslyApp.swift               # App entry, auth gate
├── ContentView.swift             # Main app container
├── Info.plist                    # App capabilities
├── newsly.entitlements           # Sign in with Apple
│
├── Models/
│   ├── User.swift                # User model
│   ├── ContentSummary.swift      # List view model
│   ├── ContentDetail.swift       # Detail view model
│   ├── ContentListResponse.swift # API response wrapper
│   ├── ContentType.swift         # article/podcast/news enum
│   ├── ContentStatus.swift       # processing status enum
│   ├── StructuredSummary.swift   # Structured summary model
│   ├── ArticleMetadata.swift     # Article-specific metadata
│   ├── PodcastMetadata.swift     # Podcast-specific metadata
│   ├── NewsMetadata.swift        # News-specific metadata
│   ├── NewsGroup.swift           # Grouped news model
│   └── AnyCodable.swift          # JSON flexibility helper
│
├── ViewModels/
│   ├── AuthenticationViewModel.swift     # Apple Sign In state
│   ├── ContentListViewModel.swift        # Main feed logic
│   ├── ContentDetailViewModel.swift      # Detail view logic
│   ├── ArticleDetailViewModel.swift      # Article-specific
│   ├── PodcastDetailViewModel.swift      # Podcast-specific
│   ├── NewsGroupViewModel.swift          # News grouping
│   └── SearchViewModel.swift             # Search functionality
│
├── Views/
│   ├── AuthenticationView.swift          # Login screen
│   ├── ContentListView.swift             # Main feed (deprecated)
│   ├── ContentDetailView.swift           # Detail screen
│   ├── ShortFormView.swift               # News feed (swipeable cards)
│   ├── LongFormView.swift                # Articles/podcasts (paged)
│   ├── FavoritesView.swift               # Favorites screen
│   ├── RecentlyReadView.swift            # Read history
│   ├── SearchView.swift                  # Search interface
│   ├── SettingsView.swift                # Settings & logout
│   ├── DebugMenuView.swift               # Debug tools
│   └── Components/
│       ├── SwipeableCard.swift           # Swipeable news card
│       ├── PagedCardView.swift           # Pageable article card
│       ├── CardStackView.swift           # Card stack container
│       ├── ContentCard.swift             # Generic content card
│       ├── NewsGroupCard.swift           # Grouped news display
│       ├── NewsDigestDetailView.swift    # News detail modal
│       ├── StructuredSummaryView.swift   # Summary display
│       ├── FilterBar.swift               # Filter controls
│       ├── FilterSheet.swift             # Filter modal
│       ├── ContentTypeBadge.swift        # Type indicator
│       ├── PlatformIcon.swift            # Source icon
│       ├── PlaceholderCard.swift         # Loading state
│       ├── LoadingView.swift             # Loading spinner
│       ├── ErrorView.swift               # Error display
│       └── ToastView.swift               # Toast notifications
│
└── Services/
    ├── APIClient.swift               # HTTP client, JWT auto-refresh
    ├── APIEndpoints.swift            # Endpoint definitions
    ├── AuthenticationService.swift   # Apple Sign In integration
    ├── KeychainManager.swift         # Secure token storage
    ├── ContentService.swift          # Content API calls
    ├── AppSettings.swift             # User preferences
    ├── ChatGPTDeepLinkService.swift  # ChatGPT integration
    ├── ToastService.swift            # Toast management
    └── UnreadCountService.swift      # Badge counts
```

**Project Root:**
```
├── templates/         # Primary Jinja templates (admin dashboard, logs, lists)
├── static/            # Tailwind sources and compiled CSS
│   └── css/
│       ├── styles.css  # Source Tailwind CSS
│       └── app.css     # Compiled output
├── scripts/           # Operational scripts (see section 18)
├── alembic/           # Database migrations
├── logs/              # JSONL and service logs (host-mounted)
├── docs/plans/        # Design docs, implementation plans
├── pyproject.toml     # Python dependencies (uv)
├── uv.lock            # Lock file
├── alembic.ini        # Alembic configuration
└── docker-compose.yml # Container orchestration
```

---
#### 12  Database Schema (Complete)

All tables defined in `app/models/schema.py` using SQLAlchemy 2.x ORM.

**`contents`** - Main content storage
- `id` INTEGER PRIMARY KEY
- `content_type` VARCHAR(20) INDEXED - "article", "podcast", "news"
- `url` VARCHAR(2048) - Content source URL
- `title` VARCHAR(500) NULLABLE - Content title
- `source` VARCHAR(100) NULLABLE INDEXED - e.g., "Import AI", "Lenny's Podcast"
- `platform` VARCHAR(50) NULLABLE INDEXED - e.g., "substack", "youtube", "twitter"
- `is_aggregate` BOOLEAN DEFAULT FALSE INDEXED - True for news digests
- `status` VARCHAR(20) DEFAULT "new" INDEXED - "new", "pending", "processing", "completed", "failed", "skipped"
- `error_message` TEXT NULLABLE - Processing error details
- `retry_count` INTEGER DEFAULT 0 - Retry attempts
- `classification` VARCHAR(20) NULLABLE INDEXED - "to_read", "skip"
- `checked_out_by` VARCHAR(100) NULLABLE INDEXED - Worker checkout lock
- `checked_out_at` DATETIME NULLABLE - Checkout timestamp
- `content_metadata` JSON DEFAULT {} - Type-specific structured data
- `created_at` DATETIME DEFAULT utcnow - Record creation
- `updated_at` DATETIME DEFAULT utcnow ONUPDATE utcnow - Last modification
- `processed_at` DATETIME NULLABLE - Processing completion time
- `publication_date` DATETIME NULLABLE INDEXED - Content publish date
- **Unique Constraint:** (`url`, `content_type`)
- **Indexes:**
  - `idx_content_type_status` (content_type, status)
  - `idx_checkout` (checked_out_by, checked_out_at)
  - `idx_created_at` (created_at)
  - `idx_content_aggregate` (content_type, is_aggregate)
  - `idx_url_content_type` (url, content_type) UNIQUE

**`processing_tasks`** - Task queue for async processing
- `id` INTEGER PRIMARY KEY
- `task_type` VARCHAR(50) INDEXED - "summarize", "transcribe", "download_audio"
- `content_id` INTEGER NULLABLE INDEXED - Reference to contents.id
- `payload` JSON DEFAULT {} - Task-specific parameters
- `status` VARCHAR(20) DEFAULT "pending" INDEXED - "pending", "processing", "completed", "failed"
- `created_at` DATETIME DEFAULT utcnow - Task creation
- `started_at` DATETIME NULLABLE - Processing start
- `completed_at` DATETIME NULLABLE - Processing completion
- `error_message` TEXT NULLABLE - Error details
- `retry_count` INTEGER DEFAULT 0 - Retry attempts
- **Index:** `idx_task_status_created` (status, created_at)

**`users`** - User accounts (authentication)
- `id` INTEGER PRIMARY KEY INDEXED
- `apple_id` VARCHAR(255) UNIQUE INDEXED - Apple Sign In identifier
- `email` VARCHAR(255) UNIQUE INDEXED - User email
- `full_name` VARCHAR(255) NULLABLE - Full name from Apple
- `is_admin` BOOLEAN DEFAULT FALSE - Admin privileges
- `is_active` BOOLEAN DEFAULT TRUE - Account status
- `created_at` DATETIME TIMEZONE-AWARE DEFAULT now() - Account creation
- `updated_at` DATETIME TIMEZONE-AWARE DEFAULT now() ONUPDATE now() - Last update

**`content_read_status`** - User read tracking
- `id` INTEGER PRIMARY KEY
- `user_id` INTEGER INDEXED - Reference to users.id
- `content_id` INTEGER INDEXED - Reference to contents.id
- `read_at` DATETIME DEFAULT utcnow - Mark read timestamp
- `created_at` DATETIME DEFAULT utcnow - Record creation
- **Unique Constraint:** (`user_id`, `content_id`)
- **Index:** `idx_content_read_user_content` (user_id, content_id) UNIQUE

**`content_favorites`** - User favorites
- `id` INTEGER PRIMARY KEY
- `user_id` INTEGER INDEXED - Reference to users.id
- `content_id` INTEGER INDEXED - Reference to contents.id
- `favorited_at` DATETIME DEFAULT utcnow - Favorite timestamp
- `created_at` DATETIME DEFAULT utcnow - Record creation
- **Unique Constraint:** (`user_id`, `content_id`)
- **Index:** `idx_content_favorites_user_content` (user_id, content_id) UNIQUE

**`content_unlikes`** - User dislikes
- `id` INTEGER PRIMARY KEY
- `user_id` INTEGER INDEXED - Reference to users.id
- `content_id` INTEGER INDEXED - Reference to contents.id
- `unliked_at` DATETIME DEFAULT utcnow - Unlike timestamp
- `created_at` DATETIME DEFAULT utcnow - Record creation
- **Unique Constraint:** (`user_id`, `content_id`)
- **Index:** `idx_content_unlikes_user_content` (user_id, content_id) UNIQUE

**`event_logs`** - Generic event logging
- `id` INTEGER PRIMARY KEY
- `event_type` VARCHAR(50) INDEXED - "scraper_run", "processing_batch", "error", "cleanup"
- `event_name` VARCHAR(100) NULLABLE INDEXED - e.g., "hackernews_scraper", "pdf_processor"
- `status` VARCHAR(20) NULLABLE INDEXED - "started", "completed", "failed"
- `data` JSON DEFAULT {} - Event-specific data
- `created_at` DATETIME DEFAULT utcnow INDEXED - Event timestamp
- **Indexes:**
  - `idx_event_type_created` (event_type, created_at)
  - `idx_event_name_created` (event_name, created_at)
  - `idx_event_status_created` (event_type, status, created_at)

**Relationships:**
- No explicit foreign keys between user tables and content tables (soft references)
- `processing_tasks.content_id` → `contents.id` (soft reference, nullable)

**Migrations:**
- Managed via Alembic (`alembic/versions/`)
- Run: `alembic upgrade head`
- Create: `alembic revision -m "description"`

---
#### 13  API Endpoints (Complete)

**Authentication (`/auth`):**
- `POST /auth/apple` - Apple Sign In (body: {id_token, email?, full_name?}) → {access_token, refresh_token, user}
- `POST /auth/refresh` - Refresh access token (body: {refresh_token}) → {access_token, refresh_token}
- `GET /auth/me` - Get current user info (requires JWT) → {id, apple_id, email, full_name, is_admin}
- `POST /auth/admin/login` - Admin password login (body: {password}) → sets httpOnly cookie
- `POST /auth/admin/logout` - Admin logout → clears cookie

**Public Content API (`/api/content`) - Requires JWT Bearer Token:**

*List & Search:*
- `GET /api/content/` - List content
  - Query params: `content_type[]`, `date`, `read_filter` (all/unread/read), `cursor`, `limit`
  - Returns: `{contents[], total, available_dates[], content_types[], next_cursor?, has_more, page_size}`
- `GET /api/content/search` - Search content
  - Query params: `q` (query), `type` (filter), `limit`, `cursor`
  - Returns: Same as list endpoint
- `GET /api/content/unread-counts` - Get unread counts by type
  - Returns: `{article: int, podcast: int, news: int}`

*Detail & Actions:*
- `GET /api/content/{id}` - Get content detail → Full ContentDetailResponse
- `GET /api/content/{id}/chatgpt-url` - Generate ChatGPT deep link → `{chat_url, truncated}`
- `POST /api/content/{id}/mark-read` - Mark content as read → `{success: bool}`
- `POST /api/content/bulk-mark-read` - Mark multiple as read (body: {content_ids: [int]}) → `{marked: int}`
- `POST /api/content/{id}/favorites/toggle` - Toggle favorite → `{is_favorited: bool}`
- `GET /api/content/favorites` - List favorites (query: `read_filter`) → Same as list endpoint
- `POST /api/content/{id}/convert` - Convert news item to article → `{status, new_content_id?, message}`

**Web UI Routes (Requires Admin Session Cookie):**
- `GET /` - Content list page (query: `content_type`, `date`, `read_filter`)
- `GET /content/{id}` - Content detail page (HTML)
- `GET /favorites` - Favorites page (query: `read_filter`)
- `GET /content/{id}/json` - Content as JSON (debugging)

**Admin Routes (Requires Admin Session):**
- `GET /admin/` - Admin dashboard (stats, recent events, errors)
- `GET /admin/logs` - List all log files
- `GET /admin/logs/{filename:path}` - View log file content
- `GET /admin/logs/{filename:path}/download` - Download log file
- `GET /admin/errors` - Error analysis dashboard (query: `hours`, `min_errors`, `component`)
- `POST /admin/errors/reset` - Delete all error logs & failed EventLog entries

**Health Check:**
- `GET /health` - Service health → `{status: "healthy"}`

**Static Files:**
- `/static/*` - CSS, JS, images (mounted from `./static/`)

---
#### 14  Pydantic Schemas (Request/Response Models)

**Authentication (`app/models/user.py`):**
- `AppleSignInRequest` - {id_token: str, email?: str, full_name?: str}
- `TokenResponse` - {access_token, refresh_token, token_type, user: UserResponse}
- `RefreshTokenRequest` - {refresh_token: str}
- `AccessTokenResponse` - {access_token, refresh_token, token_type}
- `AdminLoginRequest` - {password: str}
- `AdminLoginResponse` - {message: str}
- `UserResponse` - {id, apple_id, email, full_name?, is_admin, is_active, created_at, updated_at}

**API Content Models (`app/routers/api/models.py`):**
- `ContentSummaryResponse` - List view model (29 fields):
  - Basic: id, content_type, url, title, source, platform, is_aggregate
  - Dates: created_at, updated_at, processed_at, publication_date
  - Status: status, classification
  - User state: is_read, is_favorited
  - News fields: news_title, news_summary, news_key_points[], news_classification, news_article_url
  - Metadata: Embedded metadata objects (article/podcast/news)

- `ContentListResponse` - {contents: ContentSummaryResponse[], total, available_dates[], content_types[], next_cursor?, has_more, page_size}

- `ContentDetailResponse` - Full content model (33 fields):
  - All ContentSummaryResponse fields plus:
  - Structured summary: bullet_points[], quotes[], topics[], questions[], counter_arguments[], overview, full_markdown
  - Metadata: Complete type-specific metadata

- `BulkMarkReadRequest` - {content_ids: int[]}
- `ChatGPTUrlResponse` - {chat_url: str, truncated: bool}
- `UnreadCountsResponse` - {article: int, podcast: int, news: int}
- `ConvertNewsResponse` - {status: str, new_content_id?: int, original_content_id: int, already_exists: bool, message: str}

**Content Metadata (`app/models/metadata.py`):**
- `ContentType` - Enum("article", "podcast", "news")
- `ContentStatus` - Enum("new", "pending", "processing", "completed", "failed", "skipped")
- `ContentClassification` - Enum("to_read", "skip")
- `SummaryBulletPoint` - {text: str, category?: str}
- `ContentQuote` - {text: str, context?: str}
- `StructuredSummary` - {title, overview, bullet_points[], quotes[], topics[], questions[], counter_arguments[], summarization_date, classification, full_markdown?}
- `NewsSummary` - {title?, article_url?, key_points[], summary?, classification, summarization_date}
- `NewsArticleMetadata` - {url, title?, source_domain?}
- `NewsAggregatorMetadata` - {name?, title?, url?, external_id?, author?, metadata}
- `ArticleMetadata` - {source?, content?, author?, publication_date?, content_type, final_url_after_redirects?, word_count?, summary?}
- `PodcastMetadata` - {source?, audio_url?, transcript?, duration?, episode_number?, video_url?, video_id?, channel_name?, thumbnail_url?, view_count?, like_count?, has_transcript?, word_count?, summary?}
- `NewsMetadata` - {source?, platform?, article: NewsArticleMetadata, aggregator?: NewsAggregatorMetadata, discovery_time?, summary?: NewsSummary}
- `ContentData` - Unified wrapper with metadata validation
- `ProcessingResult` - {success, content_type, title?, metadata, error_message?, internal_links[]}
- `ProcessingError` - {error, error_type, timestamp}

**Pagination (`app/models/pagination.py`):**
- `PaginationCursorData` - {last_id, last_created_at, filters_hash?}
- `PaginationMetadata` - {next_cursor?, has_more, page_size, total?}

---
#### 15  Environment Variables (Complete)

All variables loaded via `app/core/settings.py` (Pydantic v2 BaseSettings).

**Required:**
```bash
# Database
DATABASE_URL="sqlite:///./news_app.db"  # or postgresql://user:pass@host/db

# Authentication (REQUIRED)
JWT_SECRET_KEY=<generate with: python -c "import secrets; print(secrets.token_urlsafe(32))">
JWT_ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=30
REFRESH_TOKEN_EXPIRE_DAYS=90
ADMIN_PASSWORD=<your-secure-admin-password>
```

---
#### 16  Operational Scripts (Complete)

**Start Scripts:**
- `scripts/start_server.sh` - Run migrations + uvicorn (port 8000, --reload in dev)
- `scripts/start_workers.sh` - Run migrations + install Playwright + start workers
  - Args: `--debug`, `--max-tasks N`, `--stats-interval N`, `--no-stats`
- `scripts/start_scrapers.sh` - Run scrapers with stats

**Worker Entry Points:**
- `scripts/run_workers.py` - Sequential task processor (import from `app.pipeline.sequential_task_processor`)
- `scripts/run_scrapers.py` - Scraper runner (import from `app.scraping.runner`)

**Database Management:**
- `scripts/init_database.py` - Initialize database schema
- `scripts/dump_database.py` - Export database contents to JSON
- `scripts/dump_system_stats.py` - Generate system statistics report
- `scripts/backup_database.sh` - Backup SQLite database file
- `scripts/sync_db_from_remote.sh` - Sync database from remote server
- `scripts/migrate_session_to_user.py` - Migrate session-based data to user-based
- `scripts/migrate_session_data.py` - Legacy session data migration

**Content Management:**
- `scripts/reset_content_processing.py` - Reset content processing status
- `scripts/reset_errored_content.py` - Reset failed content for retry
- `scripts/enqueue_past_day_summarization.py` - Re-queue recent content for processing
- `scripts/resummarize_podcasts.py` - Re-summarize podcast episodes
- `scripts/retranscribe_podcasts.py` - Re-transcribe podcast audio
- `scripts/generate_test_data.py` - Create test content for development

**Diagnostics:**
- `scripts/analyze_errors.py` - Analyze error logs and generate reports
- `scripts/audit_feeds.py` - Audit feed configurations
- `scripts/diagnose_youtube.py` - Debug YouTube scraper/processor
- `scripts/compare_llm_summarization.py` - Compare LLM outputs
- `scripts/test_auth_flow.sh` - Test authentication flow end-to-end

**Environment:**
- `scripts/setup_uv_env.sh` - Setup uv environment from scratch
- `scripts/install_uv_env.sh` - Install dependencies via uv
- `scripts/clean_env.sh` - Clean virtual environment

**Deployment:**
- `scripts/deploy/push_app.sh` - Deploy application to remote server
- `scripts/deploy/push_envs.sh` - Deploy environment variables to remote


---
#### 17  Key Tools & Services
- **Package/venv:** `uv` (uses `pyproject.toml` + `uv.lock`)
- **Web framework:** FastAPI with CORS, mounted static files, and Jinja2 templates
- **Database:** SQLAlchemy 2.x ORM with Alembic migrations
- **Settings:** `app/core/settings.py` (Pydantic v2 BaseSettings from `.env`)
- **Workers:** `scripts/run_workers.py` via `SequentialTaskProcessor`
- **Scrapers:** `scripts/run_scrapers.py` (scheduled via cron/supercronic in Docker)
- **LLM integration:** OpenAI, Anthropic, Google clients with Tenacity retry logic
- **Audio transcription:** Local Whisper via `app/services/whisper_local.py`
- **Content extraction:** Crawl4AI for HTML, Playwright for browser automation
- **Error logging:** `app/utils/error_logger.GenericErrorLogger` writes JSONL to `logs/errors/`
- **Event logging:** `app/services/event_logger.py` writes to `event_logs` table
- **HTTP client:** `app/http_client/robust_http_client.py` with retries and circuit breaker

---
#### 18  Running & Ops
- Dev (local):
  - `uv sync` then `. .venv/bin/activate`
  - Apply DB upgrades: `python -m alembic upgrade head`
  - Start API: `scripts/start_server.sh` (uses uvicorn)
  - Run workers: `scripts/start_workers.sh --stats-interval 60`
  - Run scrapers: `scripts/start_scrapers.sh --show-stats`
- Docker Compose:
  - Services: `server`, `workers`, `scrapers`
  - Shared logs: `./logs:/logs` and `./logs:/app/logs` (both paths map to the same host dir)
  - Up: `docker compose up -d` (use `--build` when Dockerfiles change)
- Supervisor (bare metal): point to `scripts/start_server.sh` and `scripts/start_workers.sh` (see deployment snippet in convo), write logs to `/var/log/newsly/` and symlink `/opt/newsly/logs -> /var/log/newsly` if desired.

---
#### 19  UI & Assets
- **Templates:** Jinja2 templates in `/templates` directory
- **Styling:** Tailwind CSS (source: `./static/css/styles.css`, compiled: `./static/css/app.css`)
- **Build CSS:** `npx @tailwindcss/cli -i ./static/css/styles.css -o ./static/css/app.css`
- **Static files:** Mounted at `/static` (served from `./static/` directory)
- **Admin dashboard:** `/admin/` - Stats, logs, error analysis
- **Web UI:** Server-rendered HTML (no JavaScript framework), progressive enhancement

---
#### 20  Observability & Logs
- JSONL error logs: `logs/errors/<component>_YYYYmmdd_HHMMSS.jsonl`.
- LLM parse issues: `logs/errors/llm_json_errors.log`.
- Admin views: `/admin/logs` includes JSON and JSONL formatting helpers.
- When running in Docker or Supervisor, ensure `logs/` is writable and shared as above.

---
#### 21  Quick Links (Fast Onboarding)

**Application Entry:**
- `app/main.py` — FastAPI app entry, router mounting, CORS, static files, health endpoint

**Core Infrastructure:**
- `app/core/settings.py` — Pydantic v2 settings from `.env`
- `app/core/logging.py` — Root logger/formatter configuration
- `app/core/db.py` — SQLAlchemy engine, session factory, `init_db()`, migrations helper
- `app/core/security.py` — JWT utilities, Apple token validation (⚠️ verification disabled)
- `app/core/deps.py` — FastAPI auth dependencies (`get_current_user`, `require_admin`)

**Database Models:**
- `app/models/schema.py` — SQLAlchemy ORM models (Content, ProcessingTask, User, etc.)
- `app/models/user.py` — User model + auth Pydantic schemas
- `app/models/metadata.py` — Unified Pydantic metadata models for content types

**API Routers:**
- `app/routers/auth.py` — Apple Sign In, refresh tokens, admin login/logout
- `app/routers/content.py` — Web UI routes (content list, detail, favorites)
- `app/routers/admin.py` — Admin dashboard, system stats
- `app/routers/logs.py` — Log viewing, error analysis, JSONL formatting
- `app/routers/api/` — Refactored JSON API
  - `content_list.py` — List, search, unread counts
  - `content_detail.py` — Detail view, ChatGPT URL
  - `read_status.py` — Mark read, bulk operations
  - `favorites.py` — Toggle favorites, list favorites
  - `content_actions.py` — Convert news→article

**Services Layer:**
- `app/services/openai_llm.py` — OpenAI GPT integration with JSON repair
- `app/services/anthropic_llm.py` — Anthropic Claude integration
- `app/services/google_flash.py` — Google Gemini Flash with JSON repair
- `app/services/llm_prompts.py` — Centralized prompt templates
- `app/services/favorites.py` — User favorites operations
- `app/services/read_status.py` — User read status tracking
- `app/services/queue.py` — Task queue operations, stats
- `app/services/event_logger.py` — Structured event logging
- `app/services/whisper_local.py` — Local Whisper transcription

**Pipeline & Workers:**
- `app/pipeline/sequential_task_processor.py` — Main task orchestrator
- `app/pipeline/worker.py` — ContentWorker (articles, news)
- `app/pipeline/podcast_workers.py` — PodcastDownloadWorker, TranscribeWorker
- `app/pipeline/checkout.py` — Content checkout/locking mechanism

**Scrapers:**
- `app/scraping/runner.py` — Scraper orchestrator
- `app/scraping/base.py` — Base scraper class
- `app/scraping/substack_unified.py` — Substack newsletters
- `app/scraping/podcast_unified.py` — Podcast RSS feeds
- `app/scraping/hackernews_unified.py` — Hacker News
- `app/scraping/reddit_unified.py` — Reddit via PRAW
- `app/scraping/twitter_unified.py` — Twitter/X
- `app/scraping/techmeme_unified.py` — Techmeme aggregator
- `app/scraping/youtube_unified.py` — YouTube videos
- `app/scraping/atom_unified.py` — Generic Atom/RSS feeds

**Processing Strategies:**
- `app/processing_strategies/registry.py` — Strategy registry
- `app/processing_strategies/html_strategy.py` — HTML extraction (Crawl4AI)
- `app/processing_strategies/pdf_strategy.py` — PDF extraction
- `app/processing_strategies/arxiv_strategy.py` — arXiv papers
- `app/processing_strategies/pubmed_strategy.py` — PubMed articles
- `app/processing_strategies/hackernews_strategy.py` — HN comment extraction
- `app/processing_strategies/youtube_strategy.py` — YouTube transcripts
- `app/processing_strategies/image_strategy.py` — Image content

**Utilities:**
- `app/http_client/robust_http_client.py` — Resilient HTTP client with retries
- `app/utils/error_logger.py` — JSONL error logger (auto-creates `logs/errors/`)
- `app/utils/pagination.py` — Cursor pagination utilities
- `app/utils/json_repair.py` — JSON repair for malformed LLM output

**Operational Scripts:**
- `scripts/start_server.sh` — Migrations + uvicorn server
- `scripts/start_workers.sh` — Migrations + Playwright install + workers
- `scripts/start_scrapers.sh` — Scrapers with stats
- `scripts/run_workers.py` — Worker entry point
- `scripts/run_scrapers.py` — Scraper entry point

**Containers:**
- `docker-compose.yml` — Container orchestration (server, workers, scrapers)
- `Dockerfile.server` — Server container
- `Dockerfile.workers` — Workers container
- `Dockerfile.scrapers` — Scrapers container

**iOS App (SwiftUI):**
- `client/newsly/newsly/newslyApp.swift` — App entry with auth gate
- `client/newsly/newsly/Services/APIClient.swift` — HTTP client with JWT auto-refresh
- `client/newsly/newsly/Services/AuthenticationService.swift` — Apple Sign In
- `client/newsly/newsly/Services/KeychainManager.swift` — Secure token storage
- `client/newsly/newsly/ViewModels/ContentListViewModel.swift` — Main feed logic
- `client/newsly/newsly/Views/ShortFormView.swift` — News feed (swipeable cards)
- `client/newsly/newsly/Views/LongFormView.swift` — Articles/podcasts (paged)

---
#### 22  Authentication System (Nov 2025)
**Architecture:** Dual authentication - JWT for iOS, sessions for web admin

**Backend Auth:**
- **iOS (JWT-based):** Apple Sign In only, 30min access + 90day refresh tokens
- **Web (session-based):** Admin password from `.env`, httpOnly cookies
- **User Model:** `users` table (apple_id, email, full_name, is_admin, is_active, created_at, updated_at)
- **Data Isolation:** Favorites/read-status per user_id (replaced session_id)
- **Token Rotation:** Refresh endpoint returns new access + refresh tokens

**Auth Endpoints:**
- `POST /auth/apple` — Apple Sign In (iOS users)
- `POST /auth/refresh` — Refresh access token
- `POST /auth/admin/login` — Admin login (returns session cookie)
- `POST /auth/admin/logout` — Admin logout

**Protected Routes:**
- **API routes** (`/api/content/*`) — Require JWT Bearer token
- **Web routes** (`/`, `/admin/*`, `/logs/*`) — Require admin session cookie

**Key Files:**
- `app/core/security.py` — JWT utilities, Apple token validation
- `app/core/deps.py` — FastAPI auth dependencies (get_current_user, require_admin)
- `app/models/user.py` — User model + auth schemas
- `app/routers/auth.py` — Auth endpoints
- `app/services/favorites.py` — User-based favorites (user_id parameter)
- `app/services/read_status.py` — User-based read tracking (user_id parameter)


**iOS App Integration:**
- `Services/KeychainManager.swift` — Secure token storage
- `Services/AuthenticationService.swift` — Apple Sign In integration
- `ViewModels/AuthenticationViewModel.swift` — Auth state management
- `Views/AuthenticationView.swift` — Login UI
- `Services/APIClient.swift` — Bearer token + auto-refresh

**Security Warnings (MVP):**
⚠️ **Apple token verification DISABLED** — Must implement before production (see `app/core/security.py:106`)
⚠️ **Admin sessions IN-MEMORY** — Must migrate to Redis/DB for production (see `app/routers/auth.py:31`)

