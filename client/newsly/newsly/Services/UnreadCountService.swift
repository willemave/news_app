//
//  UnreadCountService.swift
//  newsly
//
//  Created by Assistant on 7/8/25.
//

import Foundation

struct UnreadCountsResponse: Codable {
    let article: Int
    let podcast: Int
    let news: Int
}

@MainActor
class UnreadCountService: ObservableObject {
    static let shared = UnreadCountService()

    @Published var articleCount: Int = 0
    @Published var podcastCount: Int = 0
    @Published var newsCount: Int = 0

    private let client = APIClient.shared
    private var refreshTimer: Timer?

    private init() {
        // Start periodic refresh
        startPeriodicRefresh()
    }

    deinit {
        refreshTimer?.invalidate()
    }

    func refreshCounts() async {
        do {
            let response: UnreadCountsResponse = try await client.request(APIEndpoints.unreadCounts)
            articleCount = response.article
            podcastCount = response.podcast
            newsCount = response.news
        } catch {
            print("Failed to fetch unread counts: \(error)")
        }
    }
    
    private func startPeriodicRefresh() {
        refreshTimer = Timer.scheduledTimer(withTimeInterval: 30.0, repeats: true) { _ in
            Task {
                await self.refreshCounts()
            }
        }
    }
    
    func decrementArticleCount(by amount: Int = 1) {
        guard amount > 0 else { return }
        articleCount = max(articleCount - amount, 0)
    }
    
    func decrementPodcastCount(by amount: Int = 1) {
        guard amount > 0 else { return }
        podcastCount = max(podcastCount - amount, 0)
    }

    func decrementNewsCount(by amount: Int = 1) {
        guard amount > 0 else { return }
        newsCount = max(newsCount - amount, 0)
    }
    
    func incrementArticleCount() {
        articleCount += 1
    }
    
    func incrementPodcastCount() {
        podcastCount += 1
    }

    func incrementNewsCount() {
        newsCount += 1
    }
}
