{% extends "base.html" %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <!-- Back Button -->
  <div class="mb-6">
    <a href="/" class="inline-flex items-center text-sm text-blue-600 hover:text-blue-800 transition-colors">
      <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
      </svg>
      Back to Content List
    </a>
  </div>

  <!-- Content Detail Card -->
  <div class="bg-white rounded-lg shadow-sm">
    <!-- Header Section -->
    <div class="border-b border-gray-200 p-6">
      <div class="flex items-start justify-between mb-2">
        <h1 class="text-2xl font-bold text-gray-900 flex-1">
          {{ content.display_title }}
        </h1>
        <button onclick="toggleFavorite({{ content.id }})" 
                class="text-2xl hover:scale-110 transition-transform ml-4"
                title="{% if is_favorited %}Remove from favorites{% else %}Add to favorites{% endif %}">
          {% if is_favorited %}⭐{% else %}☆{% endif %}
        </button>
      </div>
      {% if content.title and content.title != content.display_title %}
      <p class="text-sm text-gray-500 mb-4">
        (Original: {{ content.title }})
      </p>
      {% endif %}
      
      <!-- Full URL -->
      {% if content.url %}
      <div class="mb-4">
        <div class="flex items-start">
          <span class="font-medium text-gray-700 mr-2">URL:</span>
          <a href="{{ content.url }}" target="_blank" rel="noopener noreferrer" 
             class="text-blue-600 hover:text-blue-800 break-all text-sm">
            {{ content.url }}
          </a>
        </div>
      </div>
      {% endif %}
      
      <!-- Metadata -->
      <div class="flex flex-wrap gap-4 text-sm text-gray-600">
        <div class="flex items-center">
          <span class="font-medium text-gray-700 mr-1">Type:</span>
          <span class="px-2 py-1 text-xs font-medium rounded-full 
                       {% if content.content_type == 'article' %}bg-blue-100 text-blue-800
                       {% elif content.content_type == 'podcast' %}bg-purple-100 text-purple-800
                       {% else %}bg-gray-100 text-gray-800{% endif %}">
            {{ content.content_type.replace('_', ' ').title() }}
          </span>
        </div>
        
        <div class="flex items-center">
          <span class="font-medium text-gray-700 mr-1">Status:</span>
          <span class="{% if content.status == 'processed' %}text-green-600
                       {% elif content.status == 'failed' %}text-red-600
                       {% else %}text-yellow-600{% endif %}">
            {{ content.status.title() }}
          </span>
        </div>
        
        {% if content.publication_date %}
        <div class="flex items-center">
          <span class="font-medium text-gray-700 mr-1">Published:</span>
          <time datetime="{{ content.publication_date }}">
            {{ content.publication_date.strftime('%B %d, %Y at %I:%M %p') }}
          </time>
        </div>
        {% endif %}
        
        {% if content.created_at %}
        <div class="flex items-center">
          <span class="font-medium text-gray-700 mr-1">Added:</span>
          <time datetime="{{ content.created_at }}">
            {{ content.created_at.strftime('%B %d, %Y at %I:%M %p') }}
          </time>
        </div>
        {% endif %}
        
        {% if content.source %}
        <div class="flex items-center">
          <span class="font-medium text-gray-700 mr-1">Source:</span>
          <span>{{ content.source }}</span>
        </div>
        {% endif %}
        
        <!-- HackerNews Metadata -->
        {% if content.metadata.hn_score is defined %}
        <div class="flex items-center">
          <span class="font-medium text-gray-700 mr-1">HN Score:</span>
          <span>{{ content.metadata.hn_score }} points</span>
        </div>
        {% endif %}
        
        {% if content.metadata.hn_comments_count is defined %}
        <div class="flex items-center">
          <span class="font-medium text-gray-700 mr-1">HN Comments:</span>
          <span>{{ content.metadata.hn_comments_count }}</span>
        </div>
        {% endif %}
      </div>
      
      <!-- URL and Share Buttons -->
      {% if content.url %}
      <div class="mt-4 flex items-center space-x-4">
        <a href="{{ content.url }}" target="_blank" rel="noopener noreferrer" 
           class="inline-flex items-center text-blue-600 hover:text-blue-800 transition-colors">
          <span class="mr-1">View Original</span>
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                  d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
          </svg>
        </a>
        
        {% if content.metadata.hn_discussion_url %}
        <a href="{{ content.metadata.hn_discussion_url }}" target="_blank" rel="noopener noreferrer" 
           class="inline-flex items-center text-orange-600 hover:text-orange-800 transition-colors">
          <span class="mr-1">View HN Discussion</span>
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                  d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
          </svg>
        </a>
        {% endif %}
        
        <button onclick="shareContent('{{ content.display_title }}', '{{ content.url }}', {{ content.bullet_points | tojson }})" 
                class="inline-flex items-center text-blue-600 hover:text-blue-800 transition-colors">
          <span class="mr-1">Share</span>
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                  d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path>
          </svg>
        </button>
        
        <button onclick="openChatModal({{ content.id }})" 
                class="inline-flex items-center text-purple-600 hover:text-purple-800 transition-colors">
          <span class="mr-1">Start AI Chat</span>
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 2C10.34 2 9 3.34 9 5c0 .38.07.75.21 1.09C8.5 6.38 7.81 6.5 7.16 6.82c-.47-.98-1.48-1.66-2.66-1.66C2.84 5.16 1.5 6.5 1.5 8.16c0 .51.13.99.36 1.42C1.33 10.34 1 11.31 1 12.33c0 1.02.33 1.99.86 2.75-.23.43-.36.91-.36 1.42 0 1.66 1.34 3 3 3 .72 0 1.38-.25 1.91-.67.65.32 1.34.5 2.09.5.38 0 .75-.07 1.09-.21.29.7.99 1.21 1.82 1.21 1.08 0 1.96-.88 1.96-1.96 0-.27-.06-.53-.16-.77.51-.23.98-.58 1.35-1.01.43.23.91.36 1.42.36 1.66 0 3-1.34 3-3 0-1.18-.68-2.19-1.66-2.68.01-.11.01-.21.01-.32 0-1.02-.33-1.99-.86-2.75.23-.43.36-.91.36-1.42 0-1.66-1.34-3-3-3-.72 0-1.38.25-1.91.67C14.34 2.88 13.75 2.5 13 2.38 12.75 2.14 12.38 2 12 2zm0 2.5c.28 0 .5.22.5.5v3c0 .28-.22.5-.5.5s-.5-.22-.5-.5V5c0-.28.22-.5.5-.5zm-3.5 2c.18 0 .35.06.5.16l2.12 2.12c.2.2.2.51 0 .71-.2.2-.51.2-.71 0L8.29 7.37c-.2-.2-.2-.51 0-.71.1-.1.26-.16.41-.16h.8zm7 0h.8c.15 0 .31.06.41.16.2.2.2.51 0 .71l-2.12 2.12c-.2.2-.51.2-.71 0-.2-.2-.2-.51 0-.71l2.12-2.12c.15-.1.32-.16.5-.16zM4.5 10.5c.28 0 .5.22.5.5s-.22.5-.5.5H3c-.28 0-.5-.22-.5-.5s.22-.5.5-.5h1.5zm16.5 0c.28 0 .5.22.5.5s-.22.5-.5.5h-1.5c-.28 0-.5-.22-.5-.5s.22-.5.5-.5H21zM8.5 14.5c.18 0 .35.06.5.16.2.2.2.51 0 .71l-2.12 2.12c-.2.2-.51.2-.71 0-.2-.2-.2-.51 0-.71l2.12-2.12c.1-.1.26-.16.41-.16h.8zm7 0h.8c.15 0 .31.06.41.16l2.12 2.12c.2.2.2.51 0 .71-.2.2-.51.2-.71 0l-2.12-2.12c-.2-.2-.2-.51 0-.71.15-.1.32-.16.5-.16zM12 15.5c.28 0 .5.22.5.5v3c0 .28-.22.5-.5.5s-.5-.22-.5-.5v-3c0-.28.22-.5.5-.5z"/>
          </svg>
        </button>
      </div>
      {% endif %}
    </div>

    <!-- Content Sections -->
    <div class="p-6 space-y-6">
      <!-- Structured Summary (if available) -->
      {% if content.structured_summary %}
      <section>
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Summary</h2>

        <!-- Accordion for Summary Sections -->
        <div class="space-y-2">
          <!-- Key Points Section (expanded by default) -->
          {% if content.bullet_points %}
          <div class="border border-gray-200 rounded-lg overflow-hidden">
            <button onclick="toggleAccordion('key-points')"
                    class="w-full flex items-center justify-between p-4 bg-gray-50 hover:bg-gray-100 transition-colors">
              <h3 class="text-md font-medium text-gray-800">Key Points</h3>
              <svg id="key-points-icon" class="w-5 h-5 transform transition-transform"
                   fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <div id="key-points-content" class="p-4 border-t border-gray-200">
              <ul class="space-y-2">
                {% for bullet in content.bullet_points %}
                <li class="flex items-start">
                  <span class="text-blue-600 mr-2 mt-0.5">•</span>
                  <div>
                    <span class="text-gray-700">{{ bullet.text }}</span>
                    {% if bullet.category %}
                    <span class="ml-2 text-xs px-2 py-1 rounded-full
                                {% if bullet.category == 'key_finding' %}bg-green-100 text-green-700
                                {% elif bullet.category == 'warning' %}bg-red-100 text-red-700
                                {% elif bullet.category == 'recommendation' %}bg-blue-100 text-blue-700
                                {% else %}bg-gray-100 text-gray-700{% endif %}">
                      {{ bullet.category.replace('_', ' ').title() }}
                    </span>
                    {% endif %}
                  </div>
                </li>
                {% endfor %}
              </ul>
            </div>
          </div>
          {% endif %}

          <!-- Questions Section -->
          {% set questions = content.structured_summary.get('questions', []) %}
          {% if questions %}
          <div class="border border-gray-200 rounded-lg overflow-hidden">
            <button onclick="toggleAccordion('questions')"
                    class="w-full flex items-center justify-between p-4 bg-gray-50 hover:bg-gray-100 transition-colors">
              <h3 class="text-md font-medium text-gray-800">Questions to Ask</h3>
              <svg id="questions-icon" class="w-5 h-5 transform transition-transform rotate-180"
                   fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <div id="questions-content" class="hidden p-4 border-t border-gray-200">
              <ol class="space-y-2 list-decimal list-inside">
                {% for question in questions %}
                <li class="text-gray-700">{{ question }}</li>
                {% endfor %}
              </ol>
            </div>
          </div>
          {% endif %}

          <!-- Counter Arguments Section -->
          {% set counter_args = content.structured_summary.get('counter_arguments', []) %}
          {% if counter_args %}
          <div class="border border-gray-200 rounded-lg overflow-hidden">
            <button onclick="toggleAccordion('counter-args')"
                    class="w-full flex items-center justify-between p-4 bg-gray-50 hover:bg-gray-100 transition-colors">
              <h3 class="text-md font-medium text-gray-800">Counter Arguments</h3>
              <svg id="counter-args-icon" class="w-5 h-5 transform transition-transform rotate-180"
                   fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <div id="counter-args-content" class="hidden p-4 border-t border-gray-200">
              <ul class="space-y-2">
                {% for arg in counter_args %}
                <li class="flex items-start">
                  <span class="text-orange-600 mr-2 mt-0.5">⚠</span>
                  <span class="text-gray-700">{{ arg }}</span>
                </li>
                {% endfor %}
              </ul>
            </div>
          </div>
          {% endif %}
        </div>

        <!-- Quotes (outside accordion, always visible if available) -->
        {% if content.quotes %}
        <div class="mt-6">
          <h3 class="text-md font-medium text-gray-800 mb-2">Notable Quotes</h3>
          <div class="space-y-3">
            {% for quote in content.quotes %}
            <blockquote class="border-l-4 border-blue-500 pl-4 py-2 bg-gray-50 rounded">
              <p class="text-gray-700 italic">"{{ quote.text }}"</p>
              {% if quote.context %}
              <cite class="text-sm text-gray-600 mt-1 block">— {{ quote.context }}</cite>
              {% endif %}
            </blockquote>
            {% endfor %}
          </div>
        </div>
        {% endif %}

        <!-- Topics (outside accordion, always visible if available) -->
        {% if content.topics %}
        <div class="mt-6">
          <h3 class="text-md font-medium text-gray-800 mb-2">Topics</h3>
          <div class="flex flex-wrap gap-2">
            {% for topic in content.topics %}
            <span class="px-3 py-1 bg-gray-100 text-gray-700 text-sm rounded-full">
              {{ topic }}
            </span>
            {% endfor %}
          </div>
        </div>
        {% endif %}
      </section>
      
      <!-- News presentation -->
      {% elif content.content_type == 'news' %}
      <section>
        <h2 class="text-lg font-semibold text-gray-900 mb-4">News Items</h2>
        {% if content.rendered_news_markdown %}
        <div class="prose prose-sm max-w-none text-gray-700">
          {{ content.rendered_news_markdown | markdown }}
        </div>
        {% elif content.news_items %}
        <ul class="list-disc pl-6 space-y-3 text-gray-700">
          {% for item in content.news_items %}
          <li>
            <a href="{{ item.url }}" class="text-blue-600 hover:text-blue-800" target="_blank" rel="noopener">
              {{ item.title or item.url }}
            </a>
            {% if item.summary %}
            <div class="text-sm text-gray-500">{{ item.summary }}</div>
            {% endif %}
            {% if item.metadata %}
            <div class="text-xs text-gray-400 mt-1 space-x-2">
              {% if item.metadata.score %}
                <span>Score: {{ item.metadata.score }}</span>
              {% endif %}
              {% if item.metadata.comments %}
                <span>Comments: {{ item.metadata.comments }}</span>
              {% endif %}
              {% if item.metadata.likes %}
                <span>Likes: {{ item.metadata.likes }}</span>
              {% endif %}
              {% if item.metadata.retweets %}
                <span>Retweets: {{ item.metadata.retweets }}</span>
              {% endif %}
              {% if item.metadata.replies %}
                <span>Replies: {{ item.metadata.replies }}</span>
              {% endif %}
            </div>
            {% endif %}
            {% if item.comments_url %}
            <div class="text-xs mt-1">
              <a href="{{ item.comments_url }}" class="text-blue-500 hover:text-blue-700" target="_blank" rel="noopener">Discussion</a>
            </div>
            {% endif %}
          </li>
          {% endfor %}
        </ul>
        {% else %}
        <p class="text-gray-500 italic">No news items available.</p>
        {% endif %}
      </section>

      <!-- Fallback to simple summary -->
      {% elif content.summary %}
      <section>
        <h2 class="text-lg font-semibold text-gray-900 mb-2">Summary</h2>
        <div class="prose prose-sm max-w-none text-gray-700">
          {{ content.summary | safe }}
        </div>
      </section>
      {% endif %}

      <!-- Raw Content or Transcript -->
      {% if content.content_type == 'article' and content.full_markdown %}
      <section>
        <h2 class="text-lg font-semibold text-gray-900 mb-2">Full Article</h2>
        <div class="prose prose-sm max-w-none text-gray-700 bg-gray-50 p-4 rounded-lg max-h-96 overflow-y-auto">
          {{ content.full_markdown | markdown }}
        </div>
      </section>
      {% elif content.content_type == 'podcast' and content.transcript %}
      <section>
        <h2 class="text-lg font-semibold text-gray-900 mb-2">Transcript</h2>
        <div class="prose prose-sm max-w-none text-gray-700 bg-gray-50 p-4 rounded-lg max-h-96 overflow-y-auto">
          {{ content.transcript | markdown }}
        </div>
      </section>
      {% endif %}

      <!-- If no content available -->
      {% if not content.short_summary and not content.summary %}
      <div class="text-center py-8">
        <p class="text-gray-500 italic">No content summary available for this item.</p>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Pre-chat Modal -->
<div id="chat-modal" class="fixed inset-0 hidden items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm z-50">
  <div class="bg-white w-full max-w-2xl mx-4 rounded-lg shadow-2xl p-6 relative">
    <button aria-label="Close chat options" onclick="closeChatModal()" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-xl">&times;</button>
    <h2 class="text-xl font-semibold text-gray-900 mb-2">How do you want to start?</h2>
    <p class="text-sm text-gray-600 mb-4">Pick a starting prompt or record a quick question. The prompt you choose appears in the chat session.</p>

    <div class="space-y-3">
      <div class="border border-gray-200 rounded-lg p-4">
        <div class="flex items-start justify-between gap-3">
          <div>
            <p class="text-sm font-medium text-gray-900">Dig deeper into the key points</p>
            <p class="text-xs text-gray-600">Expand the article's main points with implications and follow-ups.</p>
          </div>
          <button class="text-xs px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700" onclick="selectPrompt('deepDive')">Use prompt</button>
        </div>
        <div class="mt-2 bg-gray-50 text-[11px] text-gray-800 rounded p-3 font-mono leading-snug" id="prompt-preview-deepDive"></div>
      </div>

      <div class="border border-gray-200 rounded-lg p-4">
        <div class="flex items-start justify-between gap-3">
          <div>
            <p class="text-sm font-medium text-gray-900">Corroborate with fresh sources</p>
            <p class="text-xs text-gray-600">Cross-check claims using current, credible links and surface disagreements.</p>
          </div>
          <button class="text-xs px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700" onclick="selectPrompt('corroborate')">Use prompt</button>
        </div>
        <div class="mt-2 bg-gray-50 text-[11px] text-gray-800 rounded p-3 font-mono leading-snug" id="prompt-preview-corroborate"></div>
      </div>

      <div class="border border-gray-200 rounded-lg p-4">
        <div class="flex items-start justify-between gap-3">
          <div>
            <p class="text-sm font-medium text-gray-900">Ask with audio</p>
            <p class="text-xs text-gray-600">Record a quick question; we transcribe locally before starting chat.</p>
          </div>
          <button id="audio-toggle" class="text-xs px-3 py-2 bg-purple-600 text-white rounded hover:bg-purple-700" onclick="toggleAudioRecording()">Start recording</button>
        </div>
        <p id="audio-status" class="mt-2 text-xs text-gray-500">Not recording</p>
        <textarea id="audio-transcript" class="mt-2 w-full border border-gray-200 rounded p-2 text-sm" rows="2" placeholder="Transcript will appear here (you can edit before sending)"></textarea>
        <div class="flex justify-end mt-2">
          <button class="text-xs px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700" onclick="launchAudioPrompt()">Start chat with transcript</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const PRECHAT_PROMPTS = {
    deepDive: "Dig deeper into the key points. For each major point, expand on reasoning, supporting evidence, and practical implications. Keep responses concise and numbered.",
    corroborate: "Corroborate the main claims using current, reputable sources. List each claim with 2-3 supporting or conflicting sources, include URLs, and note confidence or gaps."
};

let currentContentId = {{ content.id }};
let recognition = null;
let isRecording = false;

document.addEventListener('DOMContentLoaded', () => {
    renderPromptPreviews();
});

function renderPromptPreviews() {
    const deepDiveEl = document.getElementById('prompt-preview-deepDive');
    const corroborateEl = document.getElementById('prompt-preview-corroborate');
    if (deepDiveEl) {
        deepDiveEl.textContent = PRECHAT_PROMPTS.deepDive;
    }
    if (corroborateEl) {
        corroborateEl.textContent = PRECHAT_PROMPTS.corroborate;
    }
}

function openChatModal(contentId) {
    currentContentId = contentId;
    const modal = document.getElementById('chat-modal');
    if (modal) {
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        document.body.classList.add('overflow-hidden');
    }
}

function closeChatModal() {
    const modal = document.getElementById('chat-modal');
    if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        document.body.classList.remove('overflow-hidden');
    }
    stopAudioRecording();
}

async function selectPrompt(key) {
    const promptText = PRECHAT_PROMPTS[key];
    if (!promptText) return;
    await openInChatGPT(currentContentId, promptText);
    closeChatModal();
}

function buildAudioPrompt(transcript) {
    return `The user asked (audio transcript): "${transcript}"\nUsing the article context, answer clearly. If the context lacks an answer, say so and suggest where to look.`;
}

function getSpeechRecognizer() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
        alert('Speech recognition is not supported in this browser. Please type your question.');
        return null;
    }
    const recognizer = new SpeechRecognition();
    recognizer.continuous = false;
    recognizer.interimResults = false;
    recognizer.lang = 'en-US';
    return recognizer;
}

function toggleAudioRecording() {
    if (isRecording) {
        stopAudioRecording();
        return;
    }

    const recognizer = getSpeechRecognizer();
    if (!recognizer) {
        return;
    }

    recognition = recognizer;
    isRecording = true;
    updateAudioStatus('Listening...');
    document.getElementById('audio-toggle').textContent = 'Stop recording';

    recognition.onresult = (event) => {
        const transcript = Array.from(event.results)
            .map(result => result[0].transcript)
            .join(' ')
            .trim();
        const textarea = document.getElementById('audio-transcript');
        if (textarea) {
            textarea.value = transcript;
        }
    };

    recognition.onerror = () => {
        updateAudioStatus('Could not transcribe audio.');
        stopAudioRecording();
    };

    recognition.onend = () => {
        stopAudioRecording();
    };

    recognition.start();
}

function stopAudioRecording() {
    if (recognition && isRecording) {
        recognition.stop();
    }
    isRecording = false;
    updateAudioStatus('Not recording');
    const toggleBtn = document.getElementById('audio-toggle');
    if (toggleBtn) {
        toggleBtn.textContent = 'Start recording';
    }
}

function updateAudioStatus(text) {
    const statusEl = document.getElementById('audio-status');
    if (statusEl) {
        statusEl.textContent = text;
    }
}

async function launchAudioPrompt() {
    const transcript = (document.getElementById('audio-transcript')?.value || '').trim();
    if (!transcript) {
        alert('Record or type a question first.');
        return;
    }
    await openInChatGPT(currentContentId, buildAudioPrompt(transcript));
    closeChatModal();
}

function toggleAccordion(sectionId) {
    const content = document.getElementById(`${sectionId}-content`);
    const icon = document.getElementById(`${sectionId}-icon`);

    if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        icon.classList.remove('rotate-180');
    } else {
        content.classList.add('hidden');
        icon.classList.add('rotate-180');
    }
}

async function toggleFavorite(contentId) {
    try {
        const response = await fetch(`/api/content/${contentId}/favorite`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        if (response.ok) {
            const data = await response.json();
            // Reload the page to update the UI
            window.location.reload();
        } else {
            console.error('Failed to toggle favorite');
        }
    } catch (error) {
        console.error('Error toggling favorite:', error);
    }
}

async function fetchChatUrl(contentId, userPrompt = '') {
    const params = new URLSearchParams();
    if (userPrompt) {
        params.set('user_prompt', userPrompt);
    }
    const query = params.toString();
    const resp = await fetch(`/api/content/${contentId}/chat-url${query ? `?${query}` : ''}`);
    if (!resp.ok) {
        throw new Error('Failed to get ChatGPT URL');
    }
    return resp.json();
}

async function openInChatGPT(contentId, userPrompt = '') {
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    const appStoreURL = 'https://apps.apple.com/us/app/chatgpt/id6448311069';
    const deepLink = 'chatgpt://chat/new';

    const chatUrlPromise = fetchChatUrl(contentId, userPrompt);

    if (isIOS) {
        // Try native app first
        window.location.href = deepLink;

        setTimeout(async () => {
            try {
                const data = await chatUrlPromise;
                window.location.href = appStoreURL;
                setTimeout(() => window.open(data.chat_url, '_blank'), 1800);
            } catch (error) {
                window.location.href = appStoreURL;
            }
        }, 1200);
        return;
    }

    try {
        const data = await chatUrlPromise;
        window.open(data.chat_url, '_blank');
    } catch (error) {
        console.error('Error opening ChatGPT:', error);
    }
}
</script>
{% endblock %}
