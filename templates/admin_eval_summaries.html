{% extends "base.html" %}
{% block title %}Summary Eval{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 space-y-4">
  <!-- Header -->
  <div>
    <h1 class="text-xl font-semibold text-gray-900">Summary Eval</h1>
    <p class="text-sm text-gray-500 mt-0.5">Compare model outputs on random samples from recent content.</p>
  </div>

  <!-- Configuration -->
  <div class="bg-white rounded-lg border border-gray-200 p-5 space-y-5">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
      <!-- Content Types -->
      <div>
        <h2 class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-3">Content Types</h2>
        <div class="space-y-2">
          <label class="flex items-center gap-2 text-sm text-gray-700 cursor-pointer">
            <input type="checkbox" class="content-type rounded border-gray-300 text-blue-600 focus:ring-blue-500" value="article" checked>
            <span>Article</span>
          </label>
          <label class="flex items-center gap-2 text-sm text-gray-700 cursor-pointer">
            <input type="checkbox" class="content-type rounded border-gray-300 text-blue-600 focus:ring-blue-500" value="podcast" checked>
            <span>Podcast</span>
          </label>
          <label class="flex items-center gap-2 text-sm text-gray-700 cursor-pointer">
            <input type="checkbox" class="content-type rounded border-gray-300 text-blue-600 focus:ring-blue-500" value="news" checked>
            <span>News (title focus)</span>
          </label>
        </div>
      </div>

      <!-- Template -->
      <div>
        <h2 class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-3">Long-form Template</h2>
        <select id="longform-template" class="w-full rounded-md border-gray-300 text-sm focus:ring-blue-500 focus:border-blue-500">
          {% for template_key, template_label in template_labels.items() %}
          <option value="{{ template_key }}" {% if template_key == "editorial_narrative_v1" %}selected{% endif %}>{{ template_label }}</option>
          {% endfor %}
        </select>
        <p class="text-[11px] text-gray-400 mt-1.5">Applies to article and podcast rows.</p>
      </div>

      <!-- Sampling -->
      <div>
        <h2 class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-3">Sampling</h2>
        <div class="space-y-2.5">
          <div>
            <label class="block text-[11px] text-gray-500 mb-0.5" for="recent-pool-size">Recent pool size</label>
            <input id="recent-pool-size" type="number" min="10" value="200" class="w-full rounded-md border-gray-300 text-sm py-1.5 focus:ring-blue-500 focus:border-blue-500">
          </div>
          <div>
            <label class="block text-[11px] text-gray-500 mb-0.5" for="sample-size">Sample size</label>
            <input id="sample-size" type="number" min="1" value="3" class="w-full rounded-md border-gray-300 text-sm py-1.5 focus:ring-blue-500 focus:border-blue-500">
          </div>
          <div>
            <label class="block text-[11px] text-gray-500 mb-0.5" for="seed">Seed (optional)</label>
            <input id="seed" type="number" class="w-full rounded-md border-gray-300 text-sm py-1.5 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g. 42">
          </div>
        </div>
      </div>
    </div>

    <!-- Models -->
    <div>
      <h2 class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-3">Models</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
        {% for alias, model_spec in model_specs.items() %}
        <label class="flex items-start gap-3 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors cursor-pointer">
          <input type="checkbox" class="model-option rounded border-gray-300 text-blue-600 focus:ring-blue-500 mt-0.5" value="{{ alias }}" checked>
          <div class="min-w-0">
            <div class="text-sm font-medium text-gray-900">{{ model_labels.get(alias, alias) }}</div>
            <div class="text-[11px] text-gray-400 font-mono truncate">{{ model_spec }}</div>
          </div>
        </label>
        {% endfor %}
      </div>
    </div>

    <!-- Pricing -->
    <details>
      <summary class="text-xs font-semibold text-gray-500 uppercase tracking-wide cursor-pointer hover:text-gray-700 transition-colors">
        Pricing (USD per 1M tokens)
      </summary>
      <div class="mt-3 overflow-x-auto border border-gray-200 rounded-lg">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="border-b border-gray-100">
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Model</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Input</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Output</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-50">
            {% for alias, model_spec in model_specs.items() %}
            <tr class="hover:bg-gray-50">
              <td class="px-4 py-2">
                <div class="text-sm text-gray-900">{{ model_labels.get(alias, alias) }}</div>
                <div class="text-[11px] text-gray-400 font-mono">{{ model_spec }}</div>
              </td>
              <td class="px-4 py-2">
                <input type="number" step="0.000001" min="0" class="pricing-input-input w-full rounded-md border-gray-300 text-sm py-1.5" data-model-alias="{{ alias }}" placeholder="Optional">
              </td>
              <td class="px-4 py-2">
                <input type="number" step="0.000001" min="0" class="pricing-input-output w-full rounded-md border-gray-300 text-sm py-1.5" data-model-alias="{{ alias }}" placeholder="Optional">
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </details>

    <!-- Run -->
    <div class="flex items-center gap-3 pt-2 border-t border-gray-100">
      <button id="run-eval-btn" class="bg-gray-900 text-white px-5 py-2 rounded-lg text-sm font-medium hover:bg-gray-800 disabled:opacity-50 transition-all">
        Run Eval
      </button>
      <span id="run-status" class="text-sm text-gray-500"></span>
    </div>

    <div id="run-error" class="hidden text-sm text-red-700 bg-red-50 border border-red-200 rounded-lg p-3"></div>
  </div>

  <!-- Results -->
  <div id="result-summary" class="hidden bg-white rounded-lg border border-gray-200 p-5"></div>
  <div id="result-items" class="space-y-4"></div>
</div>

<script>
  const runButton = document.getElementById('run-eval-btn');
  const runStatus = document.getElementById('run-status');
  const runError = document.getElementById('run-error');
  const resultSummary = document.getElementById('result-summary');
  const resultItems = document.getElementById('result-items');

  function escapeHtml(value) {
    return String(value ?? '')
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#39;');
  }

  function collectSelectedValues(selector) {
    return Array.from(document.querySelectorAll(selector))
      .filter((el) => el.checked)
      .map((el) => el.value);
  }

  function collectPricing() {
    const pricing = {};
    const inputNodes = document.querySelectorAll('.pricing-input-input');
    inputNodes.forEach((inputNode) => {
      const alias = inputNode.dataset.modelAlias;
      const outputNode = document.querySelector(`.pricing-input-output[data-model-alias="${alias}"]`);
      const inputValue = inputNode.value.trim();
      const outputValue = outputNode ? outputNode.value.trim() : '';
      if (!inputValue && !outputValue) return;
      pricing[alias] = {
        input_per_million_usd: inputValue ? Number(inputValue) : null,
        output_per_million_usd: outputValue ? Number(outputValue) : null,
      };
    });
    return pricing;
  }

  function formatUsage(usage) {
    if (!usage) return 'n/a';
    return `in: ${usage.input_tokens ?? 'n/a'} | out: ${usage.output_tokens ?? 'n/a'} | total: ${usage.total_tokens ?? 'n/a'}`;
  }

  function formatRequestSize(cell) {
    return `${cell.request_chars ?? 'n/a'} chars | tokens: ${cell.request_tokens_actual ?? 'n/a'} (est ${cell.request_tokens_estimate ?? 'n/a'})`;
  }

  function formatCost(cell) {
    if (cell.estimated_cost_usd === null || cell.estimated_cost_usd === undefined) {
      if (cell.cost_reason === 'pricing_not_configured') return 'n/a (pricing)';
      if (cell.cost_reason === 'usage_not_available') return 'n/a (usage)';
      return 'n/a';
    }
    return `$${Number(cell.estimated_cost_usd).toFixed(6)}`;
  }

  function renderSummary(payload) {
    const agg = payload.aggregate || {};
    const skipped = payload.skipped_models || [];
    const skippedText = skipped.length
      ? skipped.map((item) => `${item.alias}: ${item.reason}`).join(' | ')
      : 'None';

    resultSummary.innerHTML = `
      <h3 class="text-sm font-semibold text-gray-900 mb-3">Run Summary</h3>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
        <div class="border border-gray-200 rounded-lg p-3"><div class="text-xs text-gray-500 uppercase tracking-wide">Items</div><div class="text-lg font-bold text-gray-900 tabular-nums mt-0.5">${agg.items_total ?? 0}</div></div>
        <div class="border border-gray-200 rounded-lg p-3"><div class="text-xs text-gray-500 uppercase tracking-wide">Cells OK / Total</div><div class="text-lg font-bold text-gray-900 tabular-nums mt-0.5">${agg.cells_successful ?? 0} / ${agg.cells_total ?? 0}</div></div>
        <div class="border border-gray-200 rounded-lg p-3"><div class="text-xs text-gray-500 uppercase tracking-wide">Avg Latency</div><div class="text-lg font-bold text-gray-900 tabular-nums mt-0.5">${agg.avg_latency_ms ?? 'n/a'} ms</div></div>
        <div class="border border-gray-200 rounded-lg p-3"><div class="text-xs text-gray-500 uppercase tracking-wide">Est. Cost</div><div class="text-lg font-bold text-gray-900 tabular-nums mt-0.5">$${(agg.total_estimated_cost_usd ?? 0).toFixed(6)}</div></div>
      </div>
      <div class="grid grid-cols-3 gap-3 text-sm mt-3">
        <div class="border border-gray-200 rounded-lg p-3"><div class="text-xs text-gray-500 uppercase tracking-wide">Avg Req Chars</div><div class="font-semibold text-gray-900 tabular-nums mt-0.5">${agg.avg_request_chars ?? 'n/a'}</div></div>
        <div class="border border-gray-200 rounded-lg p-3"><div class="text-xs text-gray-500 uppercase tracking-wide">Avg Tokens (Actual)</div><div class="font-semibold text-gray-900 tabular-nums mt-0.5">${agg.avg_request_tokens_actual ?? 'n/a'}</div></div>
        <div class="border border-gray-200 rounded-lg p-3"><div class="text-xs text-gray-500 uppercase tracking-wide">Avg Tokens (Est)</div><div class="font-semibold text-gray-900 tabular-nums mt-0.5">${agg.avg_request_tokens_estimate ?? 'n/a'}</div></div>
      </div>
      <p class="text-[11px] text-gray-400 mt-3">Skipped: ${escapeHtml(skippedText)}</p>
    `;
    resultSummary.classList.remove('hidden');
  }

  function renderJsonAsHtml(value) {
    if (value === null || value === undefined) return '<span class="text-xs text-gray-400 italic">null</span>';
    if (Array.isArray(value)) {
      if (!value.length) return '<span class="text-xs text-gray-400 italic">[]</span>';
      return `<div class="space-y-2">${value.map((entry, i) => `
        <div class="rounded-md border border-gray-200 p-2">
          <div class="text-[10px] uppercase tracking-wide text-gray-400 mb-1">Item ${i + 1}</div>
          ${renderJsonAsHtml(entry)}
        </div>`).join('')}</div>`;
    }
    if (typeof value === 'object') {
      const entries = Object.entries(value);
      if (!entries.length) return '<span class="text-xs text-gray-400 italic">{}</span>';
      return `<dl class="space-y-1.5">${entries.map(([key, v]) => `
        <div class="border-b border-gray-50 pb-1.5">
          <dt class="text-[10px] font-semibold uppercase tracking-wide text-gray-400">${escapeHtml(key)}</dt>
          <dd class="mt-0.5 text-xs text-gray-900">${renderJsonAsHtml(v)}</dd>
        </div>`).join('')}</dl>`;
    }
    if (typeof value === 'string') return `<div class="text-xs text-gray-900 whitespace-pre-wrap">${escapeHtml(value)}</div>`;
    return `<span class="text-xs text-gray-900">${escapeHtml(String(value))}</span>`;
  }

  function renderItems(payload) {
    resultItems.innerHTML = '';
    const items = payload.results || [];

    items.forEach((item) => {
      const card = document.createElement('div');
      card.className = 'bg-white rounded-lg border border-gray-200 p-5 space-y-4';

      const title = item.source_title || 'Untitled';
      const existingSummaryTitle = item.existing_summary_title || 'n/a';
      const header = document.createElement('div');
      header.innerHTML = `
        <div class="flex flex-wrap items-center gap-2">
          <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-50 text-blue-700">${escapeHtml(item.content_type)}</span>
          <span class="text-[11px] text-gray-400 tabular-nums">ID ${escapeHtml(item.content_id)}</span>
        </div>
        <h4 class="text-sm font-semibold text-gray-900 mt-2">${escapeHtml(title)}</h4>
        <p class="text-[11px] text-gray-500 mt-1">Existing: ${escapeHtml(existingSummaryTitle)} &middot; Input: ${escapeHtml(item.input_chars ?? 'n/a')} chars</p>
        <a href="${escapeHtml(item.url)}" target="_blank" class="text-[11px] text-blue-600 hover:text-blue-800 hover:underline">${escapeHtml(item.url)}</a>
      `;
      card.appendChild(header);

      const modelResults = item.model_results || [];
      const successful = modelResults.filter((c) => c.status === 'ok' && c.display_output);
      const failed = modelResults.filter((c) => c.status !== 'ok');

      if (successful.length) {
        const grid = document.createElement('div');
        grid.className = 'grid grid-cols-1 xl:grid-cols-2 2xl:grid-cols-3 gap-3';
        successful.forEach((cell) => {
          const col = document.createElement('div');
          col.className = 'border border-green-200 rounded-lg p-4 bg-green-50/30 space-y-3';
          col.innerHTML = `
            <div>
              <div class="text-sm font-semibold text-gray-900">${escapeHtml(cell.model_label)}</div>
              <div class="text-[10px] text-gray-400 font-mono">${escapeHtml(cell.model_spec)}</div>
            </div>
            <div class="grid grid-cols-1 gap-0.5 text-[11px] text-gray-600">
              <div><span class="font-medium text-gray-800">Latency:</span> ${escapeHtml(cell.latency_ms ?? 'n/a')} ms</div>
              <div><span class="font-medium text-gray-800">Request:</span> ${escapeHtml(formatRequestSize(cell))}</div>
              <div><span class="font-medium text-gray-800">Usage:</span> ${escapeHtml(formatUsage(cell.usage))}</div>
              <div><span class="font-medium text-gray-800">Output:</span> ${escapeHtml(cell.output_chars ?? 'n/a')} chars</div>
              <div><span class="font-medium text-gray-800">Cost:</span> ${escapeHtml(formatCost(cell))}</div>
            </div>
            <div class="rounded-md border border-gray-200 bg-white p-3">
              <div class="text-[10px] font-semibold text-gray-500 uppercase tracking-wide mb-1.5">Output</div>
              ${renderJsonAsHtml(cell.display_output)}
            </div>
          `;
          grid.appendChild(col);
        });
        card.appendChild(grid);
      } else {
        const empty = document.createElement('div');
        empty.className = 'text-sm text-gray-400 border border-gray-200 rounded-lg p-4 text-center';
        empty.textContent = 'No successful responses for this item.';
        card.appendChild(empty);
      }

      if (failed.length) {
        const failedWrap = document.createElement('details');
        failedWrap.className = 'border border-red-200 bg-red-50/50 rounded-lg p-3';
        const summary = document.createElement('summary');
        summary.className = 'cursor-pointer text-sm font-medium text-red-700';
        summary.textContent = `Failed (${failed.length})`;
        failedWrap.appendChild(summary);

        const failedList = document.createElement('div');
        failedList.className = 'mt-3 space-y-2';
        failed.forEach((cell) => {
          const row = document.createElement('div');
          row.className = 'bg-white border border-red-100 rounded-md p-2 text-xs';
          row.innerHTML = `
            <div class="font-medium text-gray-900">${escapeHtml(cell.model_label)} <span class="font-mono text-gray-400">${escapeHtml(cell.model_spec)}</span></div>
            <div class="text-gray-600 mt-1"><span class="font-medium text-gray-800">Request:</span> ${escapeHtml(formatRequestSize(cell))}</div>
            <div class="text-red-600 mt-1">${escapeHtml(cell.error || 'Unknown error')}</div>
          `;
          failedList.appendChild(row);
        });
        failedWrap.appendChild(failedList);
        card.appendChild(failedWrap);
      }

      resultItems.appendChild(card);
    });
  }

  async function runEval() {
    runError.classList.add('hidden');
    runError.textContent = '';
    runButton.disabled = true;
    runStatus.textContent = 'Running...';

    try {
      const contentTypes = collectSelectedValues('.content-type');
      const models = collectSelectedValues('.model-option');
      if (!contentTypes.length) throw new Error('Select at least one content type.');
      if (!models.length) throw new Error('Select at least one model.');

      const response = await fetch('/admin/evals/summaries/run', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          content_types: contentTypes,
          models,
          longform_template: document.getElementById('longform-template').value,
          recent_pool_size: Number(document.getElementById('recent-pool-size').value),
          sample_size: Number(document.getElementById('sample-size').value),
          seed: document.getElementById('seed').value.trim() ? Number(document.getElementById('seed').value) : null,
          pricing: collectPricing(),
        }),
      });

      const payload = await response.json();
      if (!response.ok) throw new Error(payload.detail || 'Failed to run eval');

      renderSummary(payload);
      renderItems(payload);
      runStatus.textContent = 'Done';
    } catch (error) {
      runError.textContent = error.message || String(error);
      runError.classList.remove('hidden');
      runStatus.textContent = 'Failed';
    } finally {
      runButton.disabled = false;
    }
  }

  runButton.addEventListener('click', runEval);
</script>
{% endblock %}
